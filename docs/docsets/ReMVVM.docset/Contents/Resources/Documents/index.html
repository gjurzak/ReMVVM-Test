<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ReMVVM  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="ReMVVM  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">ReMVVM Docs</a> (100% documented)</p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">ReMVVM Reference</a>
        <img id="carat" src="img/carat.png" />
        ReMVVM  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="ReMVVM.html">ReMVVM</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/ReMVVM.html">ReMVVM</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/ReMVVMDriven.html">ReMVVMDriven</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Store.html">Store</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/Store.html">Store</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/StoreState.html">StoreState</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/StateObserver.html">StateObserver</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/StateMapper.html">StateMapper</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Subject.html">Subject</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Action.html">Action</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Action.html#/s:6ReMVVM11StoreActionP">StoreAction</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/Dispatcher.html">Dispatcher</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Reducer.html">Reducer</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/Reducer.html">Reducer</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/AnyReducer.html">AnyReducer</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/EmptyReducer.html">EmptyReducer</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Middleware.html">Middleware</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/Middleware.html">Middleware</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/AnyMiddleware.html">AnyMiddleware</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/Interceptor.html">Interceptor</a>
              </li>
              <li class="nav-group-task">
                <a href="Middleware.html#/s:6ReMVVM23InterceptorNextFunctiona">InterceptorNextFunction</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="StateSubject.html">StateSubject</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/StateSubject.html">StateSubject</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/AnyStateSubject.html">AnyStateSubject</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/MockStateSubject.html">MockStateSubject</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/StateAssociated.html">StateAssociated</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="ViewModel.html">ViewModel</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="ViewModel.html#/s:6ReMVVM9ViewModela">ViewModel</a>
              </li>
              <li class="nav-group-task">
                <a href="ViewModel.html#/s:6ReMVVM16ViewModelContexta">ViewModelContext</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/ViewModelProvider.html">ViewModelProvider</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/Provided.html">Provided</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="ViewModelFactory.html">ViewModelFactory</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/ViewModelFactory.html">ViewModelFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="ViewModelFactory.html#/s:6ReMVVM13Initializablea">Initializable</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/InitializableViewModelFactory.html">InitializableViewModelFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/CompositeViewModelFactory.html">CompositeViewModelFactory</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/SingleViewModelFactory.html">SingleViewModelFactory</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Deprecated.html">Deprecated</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Deprecated.html#/s:6ReMVVM15StateSubscribera">StateSubscriber</a>
              </li>
              <li class="nav-group-task">
                <a href="Deprecated.html#/s:6ReMVVM21StoreActionDispatchera">StoreActionDispatcher</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <p><a href="https://dgrzeszczak.github.io/ReMVVM"><img src="https://img.shields.io/badge/Documentation-geen" alt="Documentation"></a>
<a href="https://github.com/Carthage/Carthage"><img src="https://img.shields.io/badge/Carthage-compatible-4BC51D.svg?style=flat" alt="Carthage compatible"></a></p>
<h1 id='remvvm' class='heading'>ReMVVM</h1>

<p><em>ReMVVM</em> is an application architecture concept, marriage of <em>Unidirectional Data Flow</em> (<em>Redux</em>) with <em>MVVM</em>. </p>

<p>Redux + MVVM = ReMVVM </p>
<h1 id='motivation' class='heading'>Motivation</h1>

<p><strong>Model-View-ViewModel</strong> - is well known and widely used architecture on <em>iOS</em> platform. It is very simple, lightweight, doesn’t bring any boilerplate and works well with reactive programming (can be used without it of course). Working on the app which contain more than single view you will find couple of questions: </p>

<ul>
<li>who is responsible to create View Model ?</li>
<li>how to pass parameters to View Model’s constructor or fabric ?</li>
<li>how to implement switching to the new view ? Where to make view change and how to pass View Model to the View ?</li>
</ul>

<p>Of course you can find couple patterns to solve that such as coordinator but surprisingly easy you can follow the wrong path.</p>

<p><strong>Unidirectional Data Flow (UDF)</strong> - the main concept behind is immutable application state that can be changed only in one place in the app (<em>Store</em>) and only by predictable plain functions (in <em>Reducers</em>) ie. State + Action =  NewState. The most popular implementation of that concept is JavaScript library called <em>Redux</em>. The first and most popular swift’s implementation is <em>ReSwift</em> by Benjamin Encz. If you are not familiar with that architecture I strongly recommend to look on Benjamin’s <a href="https://academy.realm.io/posts/benji-encz-unidirectional-data-flow-swift/">presentation</a> and look into <a href="https://github.com/ReSwift/ReSwift">ReSwift</a> documentation. </p>

<p>You can find an easy example of <em>Redux</em> implementation with incrementing and decrementing single integer value. Let’s imagine you have application with 15-30 screens, all with complicated view structure and communication with backend API. It will bring complicated <em>Application State</em>, a lot of <em>Reducers</em> and dozens or even hundreds of <em>Actions</em> for the state changes. </p>

<p>But… what about making a mix of two architectures ? Can we implement “global” app state by <em>Unidirectional Data Flow</em> and use <em>MVVM</em> pattern for each screen in the app with all benefits it has ? We can and it is what <em>ReMVVM</em> was made for.</p>
<h1 id='components' class='heading'>Components</h1>

<p>In <em>ReMVVM</em> we can divide components on two groups related with <em>Unidirectional Data Flow</em> and <em>MVVM</em></p>

<p><img src="https://raw.githubusercontent.com/dgrzeszczak/ReMVVM/master/images/ReMVVM_architecture_components.png" alt=""> </p>
<h2 id='unidirectional-data-flow' class='heading'>Unidirectional Data Flow:</h2>

<p><strong><code><a href="Classes/Store.html">Store</a></code></strong> - contains your application state that can be modified only by dispatching an <code><a href="Action.html#/s:6ReMVVM11StoreActionP">StoreAction</a></code>. Every state change is notified to every <code><a href="Protocols/StateObserver.html">StateObserver</a></code>.</p>

<p><strong><code><a href="Protocols/StoreState.html">StoreState</a></code></strong> - it’s immutable data structure that holds your application data. In <em>ReMVVM</em> it has to provide <em><code><a href="Protocols/ViewModelFactory.html">ViewModelFactory</a></code></em> that will be used for creating View Models for your view(s).</p>

<p><strong><code><a href="Action.html#/s:6ReMVVM11StoreActionP">StoreAction</a></code></strong> - describes state change and is handled by corresponding <em><code><a href="Protocols/Reducer.html">Reducer</a></code></em>. </p>

<p><strong><code><a href="Protocols/Middleware.html">Middleware</a></code></strong> - mechanism for enhance action’s dispatch functionality. It is usually used to simplify asynchronous dispatch and implement ‘side effects’ if required.</p>

<p><strong><code><a href="Protocols/Reducer.html">Reducer</a></code></strong> - provides pure function that returns new state based on current state and the action. </p>

<p><strong><em>Note:</em></strong> <em>There is a small difference between Redux implementation and ReMVVM. In Redux one reducer can handle any type of action. Because of that we can see a lot of switch blocks inside reducers and it’s not clear where the action is finally handled. In ReMVVM reducer can handle exactly one type of the action. Action handling is separated into different reducers what makes the code more clean. <code><a href="Structs/AnyReducer.html">AnyReducer</a></code> is used to compose multiple <code><a href="Protocols/Reducer.html">Reducer</a></code>s</em> </p>
<h2 id='mvvm' class='heading'>MVVM:</h2>

<p><strong><code><a href="ViewModel.html#/s:6ReMVVM9ViewModela">ViewModel</a></code></strong> - is designed to store and manage UI related data for the view</p>

<p><strong><code><a href="Structs/ViewModelProvider.html">ViewModelProvider</a></code></strong> - provides View Model(s) for the context (View)</p>

<p><strong><code><a href="Protocols/ViewModelFactory.html">ViewModelFactory</a></code></strong> - creates View Model instances</p>

<p><em><code><a href="ViewModel.html#/s:6ReMVVM9ViewModela">ViewModel</a></code></em> provided by <em><code><a href="Structs/ViewModelProvider.html">ViewModelProvider</a></code></em> lives as long as the context which was created for (for more detail please look at <a href="https://github.com/dgrzeszczak/MVVM">MVVM library</a> which is a part of <em>ReMVVM</em>). <em><code><a href="ViewModel.html#/s:6ReMVVM9ViewModela">ViewModel</a></code></em> provided by <em><code><a href="Structs/ViewModelProvider.html">ViewModelProvider</a></code></em> may be also created without context but in that case developer is responsible for handling <code><a href="ViewModel.html#/s:6ReMVVM9ViewModela">ViewModel</a></code> life-cycle.</p>
<h1 id='example' class='heading'>Example</h1>

<p>We will build application containing two screens. On the Login screen user may enter his first and second name. And greeting screen that presents values entered on previous screen.</p>

<table><thead>
<tr>
<th><img src="https://raw.githubusercontent.com/dgrzeszczak/ReMVVM/master/images/LoginViewController_screenshot.png" alt=""></th>
<th></th>
<th><img src="https://raw.githubusercontent.com/dgrzeszczak/ReMVVM/master/images/GreetingsViewController_screenshot.png" alt=""></th>
</tr>
</thead><tbody>
</tbody></table>

<p><strong><em>Note:</em></strong> <em>We use RxSwift/RxCocoa in the example because it&rsquo;s great fit to MVVM architecture but please remember there is no need to use any Reactive framework with ReMVVM and there is no dependency to Rx libarary.</em> </p>

<p>First we need a struct for State with the data for our app. It contain data for logged in <code>User</code> and it also have to provide factory for our View Models. </p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">AppState</span><span class="p">:</span> <span class="kt">StoreState</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">factory</span><span class="p">:</span> <span class="kt">ViewModelFactory</span>

    <span class="k">let</span> <span class="nv">user</span><span class="p">:</span> <span class="kt">User</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">User</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">firstName</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">lastName</span><span class="p">:</span> <span class="kt">String</span>
<span class="p">}</span>
</code></pre>

<p>Let&rsquo;s create view models for our screens. <code>LoginViewModel</code> implements <code><a href="ViewModelFactory.html#/s:6ReMVVM13Initializablea">Initializable</a></code> and it is used by <code><a href="Structs/InitializableViewModelFactory.html">InitializableViewModelFactory</a></code> or <code><a href="Classes/CompositeViewModelFactory.html">CompositeViewModelFactory</a></code> for creating View Models by using default/empty constructor. So it means you don&rsquo;t need to provide factory method for it. </p>

<p><code><a href="Protocols/StateObserver.html">StateObserver</a></code> means that your view model will be automatically notified on any state changes in store. Here it&rsquo;s used for clearing first and second name values when user logs out.</p>
<pre class="highlight swift"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">LoginViewModel</span><span class="p">:</span> <span class="kt">StateObserver</span><span class="p">,</span> <span class="kt">Initializable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">firstName</span> <span class="o">=</span> <span class="kt">BehaviorSubject</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">lastName</span> <span class="o">=</span> <span class="kt">BehaviorSubject</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>

    <span class="kd">func</span> <span class="nf">didChange</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">AppState</span><span class="p">,</span> <span class="nv">oldState</span><span class="p">:</span> <span class="kt">AppState</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">oldState</span><span class="p">?</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="c1">// reset values on logout</span>
            <span class="n">firstName</span><span class="o">.</span><span class="nf">onNext</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
            <span class="n">lastName</span><span class="o">.</span><span class="nf">onNext</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>But let&rsquo;s have a look how we can do it more reactive way. Instead of using <code><a href="Protocols/StateObserver.html">StateObserver</a></code> directly we can use combination of <code><a href="Protocols/ReMVVMDriven.html">ReMVVMDriven</a></code> with <code><a href="Protocols/StateAssociated.html">StateAssociated</a></code> protocols. Marking object <code><a href="Protocols/ReMVVMDriven.html">ReMVVMDriven</a></code> means that it&rsquo;s implementation is based on <em>ReMVVM</em> and it gives us additional functionalities using <code><a href="Structs/ReMVVM.html">ReMVVM</a></code> object. It contains <code><a href="Structs/AnyStateSubject.html">AnyStateSubject</a></code> that provides current value of the state and allows registering  the <code><a href="Protocols/StateObserver.html">StateObserver</a></code> for state updates. Thanks to that we can write our own reactive extension (you can find it in the example&rsquo;s source code). It is worth to mention that you can easily inject <code><a href="Classes/MockStateSubject.html">MockStateSubject</a></code> to your <code><a href="ViewModel.html#/s:6ReMVVM9ViewModela">ViewModel</a></code> and easily write unit tests for your view model. Implementation of LoginViewModel may look like that. </p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">LoginViewModel</span><span class="p">:</span> <span class="kt">ReMVVMDriven</span><span class="p">,</span> <span class="kt">StateAssociated</span><span class="p">,</span> <span class="kt">Initializable</span> <span class="p">{</span>

    <span class="kd">typealias</span> <span class="kt">State</span> <span class="o">=</span> <span class="kt">AppState</span>

    <span class="k">let</span> <span class="nv">firstName</span> <span class="o">=</span> <span class="kt">BehaviorSubject</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">lastName</span> <span class="o">=</span> <span class="kt">BehaviorSubject</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>

    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">stateSubject</span><span class="p">:</span> <span class="k">Self</span><span class="o">.</span><span class="n">remvvm</span><span class="o">.</span><span class="n">stateSubject</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">disposeBag</span> <span class="o">=</span> <span class="kt">DisposeBag</span><span class="p">()</span>

    <span class="c1">// here you can inject MockStateSubject&lt;AppState&gt; in your unit tests</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">stateSubject</span><span class="p">:</span> <span class="kt">AnyStateSubject</span><span class="o">&lt;</span><span class="kt">AppState</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">state</span> <span class="o">=</span> <span class="n">stateSubject</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">state</span> <span class="c1">// Observer&lt;AppState&gt;</span>
        <span class="n">state</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">user</span><span class="p">?</span><span class="o">.</span><span class="n">firstName</span> <span class="p">??</span> <span class="s">""</span> <span class="p">}</span><span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">firstName</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">user</span><span class="p">?</span><span class="o">.</span><span class="n">lastName</span> <span class="p">??</span> <span class="s">""</span> <span class="p">}</span><span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">lastName</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p><code>GreetingsViewModel</code> is really simple</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">GreetingsViewModel</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">messageLabel</span><span class="p">:</span> <span class="kt">Observable</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span>

    <span class="nf">init</span><span class="p">(</span><span class="n">with</span> <span class="nv">user</span><span class="p">:</span> <span class="kt">User</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">messageLabel</span> <span class="o">=</span> <span class="o">.</span><span class="nf">just</span><span class="p">(</span><span class="s">"Hello </span><span class="se">\(</span><span class="n">user</span><span class="o">.</span><span class="n">firstName</span><span class="se">)</span><span class="s"> </span><span class="se">\(</span><span class="n">user</span><span class="o">.</span><span class="n">lastName</span><span class="se">)</span><span class="s"> &lt;3"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>For the simplicyty of the example we will use one factory for all states. Other solution is to use seperate factories for each screen or module in the app. As alredy mentioned <code><a href="Classes/CompositeViewModelFactory.html">CompositeViewModelFactory</a></code> by defauts are able to create <code><a href="ViewModelFactory.html#/s:6ReMVVM13Initializablea">Initializable</a></code> View Models so we only need to add factory for <code>GreetingsViewModel</code>. </p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">factory</span> <span class="o">=</span> <span class="kt">CompositeViewModelFactory</span><span class="p">()</span>
<span class="n">factory</span><span class="o">.</span><span class="n">add</span> <span class="p">{</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kt">GreetingsViewModel</span><span class="p">?</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">user</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="kt">GreetingsViewModel</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>Ok so that&rsquo;s all regarding <em>MVVM</em> part. Let&rsquo;s see how to implement <em>Unidirectional Data Flow</em> part. We will have two actions:</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">LoginAction</span><span class="p">:</span> <span class="kt">StoreAction</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">firstName</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">lastName</span><span class="p">:</span> <span class="kt">String</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">LogoutAction</span><span class="p">:</span> <span class="kt">StoreAction</span> <span class="p">{</span> <span class="p">}</span>
</code></pre>

<p>And two reducers for each of them: </p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">LoginReducer</span><span class="p">:</span> <span class="kt">Reducer</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">reduce</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">AppState</span><span class="p">,</span> <span class="n">with</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">LoginAction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AppState</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="kt">User</span><span class="p">(</span><span class="nv">firstName</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">firstName</span><span class="p">,</span> <span class="nv">lastName</span><span class="p">:</span> <span class="n">action</span><span class="o">.</span><span class="n">lastName</span><span class="p">)</span>
        <span class="k">return</span> <span class="kt">AppState</span><span class="p">(</span><span class="nv">factory</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">factory</span><span class="p">,</span> <span class="nv">user</span><span class="p">:</span> <span class="n">user</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">LogoutReducer</span><span class="p">:</span> <span class="kt">Reducer</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">reduce</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">AppState</span><span class="p">,</span> <span class="n">with</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">LogoutAction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AppState</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">AppState</span><span class="p">(</span><span class="nv">factory</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">factory</span><span class="p">,</span> <span class="nv">user</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre>

<p>We can initialize <em>ReMVVM</em> like that: </p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">reducer</span> <span class="o">=</span> <span class="kt">AnyReducer</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="p">[</span><span class="kt">LoginReducer</span><span class="o">.</span><span class="n">any</span><span class="p">,</span> <span class="kt">LogoutReducer</span><span class="o">.</span><span class="n">any</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">store</span> <span class="o">=</span> <span class="kt">Store</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">initialState</span><span class="p">,</span> <span class="nv">reducer</span><span class="p">:</span> <span class="n">reducer</span><span class="p">,</span> <span class="nv">middleware</span><span class="p">:</span> <span class="n">middleware</span><span class="p">)</span>

<span class="kt">ReMVVM</span><span class="o">.</span><span class="nf">initialize</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">store</span><span class="p">)</span>
</code></pre>

<p>Now we can write ours view controllers. Please notice <code><a href="Protocols/ReMVVMDriven.html">ReMVVMDriven</a></code> protocol which gives us <code><a href="Structs/ReMVVM.html">ReMVVM</a></code> object to get view models and allows us to dispatch actions. </p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">LoginViewController</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">,</span> <span class="kt">ReMVVMDriven</span> <span class="p">{</span>

    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">firstNameTextField</span><span class="p">:</span> <span class="kt">UITextField</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">lastNameTextField</span><span class="p">:</span> <span class="kt">UITextField</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">loginButton</span><span class="p">:</span> <span class="kt">UIButton</span><span class="o">!</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">disposeBag</span> <span class="o">=</span> <span class="kt">DisposeBag</span><span class="p">()</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>

        <span class="c1">// inject view model from remvvm</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">LoginViewModel</span> <span class="o">=</span> <span class="n">remvvm</span><span class="o">.</span><span class="nf">viewModel</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="c1">// bind view model to view</span>
        <span class="n">viewModel</span><span class="o">.</span><span class="n">firstName</span><span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">firstNameTextField</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="n">viewModel</span><span class="o">.</span><span class="n">lastName</span><span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">lastNameTextField</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>

        <span class="c1">// bind view to view model</span>
        <span class="n">firstNameTextField</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">orEmpty</span><span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">viewModel</span><span class="o">.</span><span class="n">firstName</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
        <span class="n">lastNameTextField</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">orEmpty</span><span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">viewModel</span><span class="o">.</span><span class="n">lastName</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>

        <span class="c1">// handle login button tap</span>
        <span class="c1">// without rx: self.remvvm.dispatch(action: LoginAction(firstName: , lastName:))</span>
        <span class="n">loginButton</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">tap</span>
            <span class="o">.</span><span class="nf">withLatestFrom</span><span class="p">(</span><span class="kt">Observable</span><span class="o">.</span><span class="nf">combineLatest</span><span class="p">(</span><span class="n">viewModel</span><span class="o">.</span><span class="n">firstName</span><span class="p">,</span> <span class="n">viewModel</span><span class="o">.</span><span class="n">lastName</span><span class="p">))</span>
            <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">LoginAction</span><span class="o">.</span><span class="kd">init</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">remvvm</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Thanks to swift 5.1 we have possibility to use @propertyWrapper mechanism. Here you can see another way of getting view models and inject them to views by <code>@Provided</code> property wrapper. </p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">GreetingsViewController</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">,</span> <span class="kt">ReMVVMDriven</span> <span class="p">{</span>

    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">messageLabel</span><span class="p">:</span> <span class="kt">UILabel</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">logoutButton</span><span class="p">:</span> <span class="kt">UIButton</span><span class="o">!</span>

    <span class="c1">// get view model from remvvm</span>
    <span class="kd">@Provided</span> <span class="kd">private</span> <span class="k">var</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">GreetingsViewModel</span><span class="p">?</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">disposeBag</span> <span class="o">=</span> <span class="kt">DisposeBag</span><span class="p">()</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>

        <span class="c1">// handle logout button tap</span>
        <span class="c1">// without Rx: self.remvvm.dispatch(action: LogoutAction())</span>
        <span class="n">logoutButton</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">tap</span>
            <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">LogoutAction</span><span class="p">()</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">remvvm</span><span class="o">.</span><span class="n">rx</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>

        <span class="c1">// bind view model to the view</span>
        <span class="n">viewModel</span><span class="p">?</span><span class="o">.</span><span class="n">messageLabel</span><span class="o">.</span><span class="nf">bind</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="n">messageLabel</span><span class="o">.</span><span class="n">rx</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="nf">disposed</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">disposeBag</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The last concept whould like to show is how we can handle navigation in the app using <em>ReMVVM</em>. We could have add navigation changes after dispatching each action in UIViewControllers but please notice we didn&rsquo;t handle it there. So where it is ? It&rsquo;s implemented in the component called <em><code><a href="Protocols/Middleware.html">Middleware</a></code></em>. It&rsquo;s mechanism that can change dispatch of the action and is offten used for asynchronous requests and side effect (in our case side effect for state change is displaying new screen of the app). </p>

<p><em>Middleware</em> is a stack of objects and each action dispatched in the store is passed thorugh each element of that stack. It&rsquo;s done by calling <code>next()</code> method from <code><a href="Structs/Interceptor.html">Interceptor</a></code>. On the end action is reduced in reducer and the state in the store is changed. After state is changed the completion block from <code>next()</code> is called in backward order. If you don&rsquo;t call <code>next()</code> method the action&rsquo;s dispatch will break and as a result reducer will not be called and state will not change. It can be intentional in some cases for example when you need to download some data asynchronously.</p>

<p>In middleware you can also dispatch completly new action by calling <code>dispatch(action:)</code> from <code><a href="Protocols/Dispatcher.html">Dispatcher</a></code>. </p>

<p>Let&rsquo;s back to our example and define really simple <code>UIState</code> that give us possibility to navigate through the app. </p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">UIState</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">rootViewController</span><span class="p">:</span> <span class="kt">UIViewController</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">rootViewController</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="n">rootViewController</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">showModal</span><span class="p">(</span><span class="nv">controller</span><span class="p">:</span> <span class="kt">UIViewController</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">rootViewController</span><span class="o">.</span><span class="nf">present</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">dismissModal</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">rootViewController</span><span class="o">.</span><span class="n">presentedViewController</span><span class="p">?</span><span class="o">.</span><span class="nf">dismiss</span><span class="p">(</span><span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nv">completion</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>And then we can define our middlewares.</p>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">LoginMiddleware</span><span class="p">:</span> <span class="kt">Middleware</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">uiState</span><span class="p">:</span> <span class="kt">UIState</span>

    <span class="kd">func</span> <span class="nf">onNext</span><span class="p">(</span><span class="k">for</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">AppState</span><span class="p">,</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">LoginAction</span><span class="p">,</span> <span class="nv">interceptor</span><span class="p">:</span> <span class="kt">Interceptor</span><span class="o">&lt;</span><span class="kt">LoginAction</span><span class="p">,</span> <span class="kt">AppState</span><span class="o">&gt;</span><span class="p">,</span> <span class="nv">dispatcher</span><span class="p">:</span> <span class="kt">Dispatcher</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// here you can do something asynchronously - like download user data</span>
        <span class="c1">// ....</span>

        <span class="n">interceptor</span><span class="o">.</span><span class="n">next</span> <span class="p">{</span> <span class="n">state</span> <span class="k">in</span>
            <span class="c1">// this closure is called after action is handled by reducer - can be used for side effects like that ;)</span>
            <span class="k">let</span> <span class="nv">storyboard</span> <span class="o">=</span> <span class="kt">UIStoryboard</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Main"</span><span class="p">,</span> <span class="nv">bundle</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">controller</span> <span class="o">=</span> <span class="n">storyboard</span><span class="o">.</span><span class="nf">instantiateViewController</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="s">"LogoutViewController"</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">uiState</span><span class="o">.</span><span class="nf">showModal</span><span class="p">(</span><span class="nv">controller</span><span class="p">:</span> <span class="n">controller</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<pre class="highlight swift"><code><span class="kd">struct</span> <span class="kt">LogoutMiddleware</span><span class="p">:</span> <span class="kt">Middleware</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">uiState</span><span class="p">:</span> <span class="kt">UIState</span>

    <span class="kd">func</span> <span class="nf">onNext</span><span class="p">(</span><span class="k">for</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">AppState</span><span class="p">,</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">LogoutAction</span><span class="p">,</span> <span class="nv">interceptor</span><span class="p">:</span> <span class="kt">Interceptor</span><span class="o">&lt;</span><span class="kt">LogoutAction</span><span class="p">,</span> <span class="kt">AppState</span><span class="o">&gt;</span><span class="p">,</span> <span class="nv">dispatcher</span><span class="p">:</span> <span class="kt">Dispatcher</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">interceptor</span><span class="o">.</span><span class="n">next</span> <span class="p">{</span> <span class="n">state</span> <span class="k">in</span>
            <span class="k">self</span><span class="o">.</span><span class="n">uiState</span><span class="o">.</span><span class="nf">dismissModal</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>The biggest advantage is that UIViewControllers know nothing about each other. They are not connected at all, you can easily change the flow of the application without touching UIViewControllers. </p>
<h1 id='summary' class='heading'>Summary</h1>

<p><em>ReMVVM</em> architecture brings great separation between layers. It&rsquo;s clear where to store model data, who and where creates view model and how it&rsquo;s passed to the view. It takes the biggest advantages of two different architectures and makes the code readable without introducing any boilerplate.</p>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2019 <a class="link" href="https://github.com/dgrzeszczak" target="_blank" rel="external">Dariusz Grzeszczak</a>. All rights reserved. (Last updated: 2019-12-23)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.0</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
